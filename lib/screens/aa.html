<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DreamAnalyser</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0e0e0e;
      color: #ffffff;
      text-align: center;
      padding: 2rem;
    }

    textarea, button {
      width: 90%;
      max-width: 600px;
      margin: 1rem auto;
      padding: 1rem;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
    }

    button {
      background-color: #ff0080;
      color: #fff;
      cursor: pointer;
    }

    .story-section {
      max-width: 900px;
      margin: 2rem auto;
      text-align: left;
    }

    .story-block {
      margin-bottom: 3rem;
    }

    img {
      width: 100%;
      max-height: 400px;
      object-fit: cover;
      border-radius: 12px;
      margin-top: 1rem;
    }

    .loading {
      color: #ffcc00;
      font-size: 1.2rem;
      margin-top: 2rem;
    }
  </style>
</head>
<body>

  <h1>üåô DreamAnalyser</h1>
  <p>Describe your dream. We'll turn it into a story with visual scenes.</p>

  <textarea id="dreamInput" placeholder="Enter your dream..." rows="4"></textarea><br>
  <button onclick="analyzeDream()">Analyze Dream</button>

  <div id="loadingText" class="loading" style="display:none;">Analyzing dream...</div>
  <div class="story-section" id="outputSection" style="display:none;"></div>

  <script>
    const _textApiBase = 'https://text.pollinations.ai/';
    const _imageApiBase = 'https://image.pollinations.ai/prompt/';

    async function analyzeDream() {
      const prompt = document.getElementById('dreamInput').value.trim();
      const outputSection = document.getElementById('outputSection');
      const loadingText = document.getElementById('loadingText');
      outputSection.innerHTML = '';
      outputSection.style.display = 'none';
      loadingText.style.display = 'block';

      if (!prompt) {
        alert("Please enter a dream description.");
        loadingText.style.display = 'none';
        return;
      }

      const story = await generateStory(prompt);
      const paragraphs = splitIntoParagraphs(story);

      if (paragraphs.length === 0) {
        outputSection.innerHTML = "<p>‚ùå Could not generate a valid story. Try again later.</p>";
        outputSection.style.display = 'block';
        loadingText.style.display = 'none';
        return;
      }

      for (let i = 0; i < paragraphs.length; i++) {
        const para = paragraphs[i];
        const imageUrl = _imageApiBase + encodeURIComponent(para);

        const block = document.createElement('div');
        block.className = 'story-block';

        const paraText = document.createElement('p');
        paraText.textContent = para;

        const img = document.createElement('img');
        img.src = imageUrl;
        img.alt = "Generated Dream Scene " + (i + 1);

        block.appendChild(paraText);
        block.appendChild(img);
        outputSection.appendChild(block);
      }

      loadingText.style.display = 'none';
      outputSection.style.display = 'block';
    }

    async function generateStory(prompt) {
      try {
        const response = await fetch(_textApiBase, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: "Dream Story",
            subtitle: "Generated by AI",
            prompt: prompt
          })
        });

        const data = await response.json();
        console.log("Text API response:", data);

        // Validate response
        if (data && data.text && typeof data.text === 'string') {
          return data.text;
        } else {
          return "";
        }
      } catch (err) {
        console.error("Text API Error:", err);
        return "";
      }
    }

    function splitIntoParagraphs(text) {
      if (!text) return [];
      return text
        .split(/\n+/)
        .map(p => p.trim())
        .filter(p => p.length > 30)
        .slice(0, 4); // Only first 4 paragraphs
    }
  </script>

</body>
</html>
